\documentclass[12pt, a4paper]
{article}

\usepackage{svg}
\setsvg{inkscape=inkscape -z -D,svgpath=images/}
\usepackage{float}
\usepackage{amsmath}
\usepackage{todonotes}

\providecommand{\todos}[1]{\todo[inline]{#1}}
\providecommand{\ang}[1]{\theta_{\text{#1}}}
\providecommand{\sub}[1]{_{\text{#1}}}
\providecommand{\subi}[1]{_{\text{#1},i}}
\providecommand{\twonorm}[1]{\left|\left|#1\right|\right|}
\providecommand{\foralli}{\quad \forall\, i}
\providecommand{\lr}[1]{\left( {#1} \right)}

\providecommand{\tr}{\tilde{r}}
\providecommand{\inert}{w}
\providecommand{\br}{\boldsymbol{r}}
\providecommand{\btr}{\tilde{\br}}

\providecommand{\xh}{\hat{x}}
\providecommand{\yh}{\hat{y}}

\providecommand{\qcom}{, \qquad}


\title{Reference frame conversions}
\author{Laurens Valk}
\begin{document}
\maketitle

\tableofcontents

\section{From Pixels to Meters} 
\subsection{Transformation Matrices}
The symbol $\tr$ expresses vectors in units of pixels. Any other vector $r$ has units of meters.
\begin{figure}[H]
\centering
\includesvg[width=1\textwidth]{scaling}
\caption{Four coordinates: a) in the camera picture, b) with flipped y axis, c) with the origin at the center of the picture, d) scaled to physical distances.
\label{fig:robotframe}}
\end{figure}

\begin{equation}
\begin{bmatrix}
\tr^f\\
1
\end{bmatrix} = \begin{bmatrix}
1 & 0 & 0\\
0 & -1 & 0\\
0& 0 & 1
\end{bmatrix}\begin{bmatrix}
\tr^p\\1
\end{bmatrix}=H^f_p \begin{bmatrix}
\tr^p\\1
\end{bmatrix}
\end{equation}
\begin{equation}
\begin{bmatrix}
\tr^c\\
1
\end{bmatrix} = \begin{bmatrix}
1 & 0 & -\frac{1}{2}\tilde{d}_x\\
0 & 1 & \frac{1}{2}\tilde{d}_y\\
0& 0 & 1
\end{bmatrix}\begin{bmatrix}
\tr^f\\1
\end{bmatrix}=H^c_f \begin{bmatrix}
\tr^f\\1
\end{bmatrix}
\end{equation}
\begin{equation}
\begin{bmatrix}
r^{\inert}\\
1
\end{bmatrix} = \begin{bmatrix}
\varepsilon & 0 & 0\\
0 & \varepsilon & 0\\
0& 0 & 1
\end{bmatrix}\begin{bmatrix}
\tr^c\\1
\end{bmatrix}=H^{\inert}_c \begin{bmatrix}
\tr^c\\1
\end{bmatrix}
\end{equation}

\begin{equation}
\begin{bmatrix}
r^{\inert}\\
1
\end{bmatrix} = H^{\inert}_c H^c_f H^f_p \begin{bmatrix}
\tr^p\\1
\end{bmatrix}
\end{equation}
%
The overall transformation from pixels to the real world representation is
%
\begin{equation}
\begin{bmatrix}
r^{\inert}\\
1
\end{bmatrix} = H^{\inert}_p \begin{bmatrix}
\tr^p\\1
\end{bmatrix} \quad \Rightarrow \quad \br^{\inert} = H^{\inert}_p 
\btr^p
\end{equation}
%
where
%
\begin{equation}
H^{\inert}_p =H^{\inert}_c H^c_f H^f_p = \begin{bmatrix}
 \varepsilon&    0& -\frac{1}{2}\varepsilon \tilde{d}_x\\
   0& -\varepsilon&  \frac{1}{2}\varepsilon \tilde{d}_y\\
0&    0&           1
\end{bmatrix}
\end{equation}



\subsection{Scaling Factor}
%
The distance $d\sub{top/center}$ in Figure \ref{fig:robotframe} is known, constant, and equivalent for each agent:
%
\begin{equation}
d\sub{top/center} \equiv \twonorm{r\subi{top}-r\subi{center}} \foralli
\end{equation}
%
Per agent, we can estimate the scaling factor $\epsilon_i$ as:
%
\begin{equation}
\varepsilon_i = \dfrac{d\sub{top/center}}{\twonorm{\tr\subi{top}-\tr\subi{center}}} \quad \text{m/pixel}
\end{equation}
%
A more accurate estimate for the overall scaling factor is:
%
\begin{equation}
\varepsilon = \dfrac{1}{N}\sum^N_{i=1} \varepsilon_i
\end{equation}
%
However, because $\varepsilon$ is constant it may be more desirable to calculate it once and use it as a constant parameter. If so, we may divide the arena width by the picture with in pixels:
%
\begin{equation}
\varepsilon = \dfrac{d\sub{field}}{\tilde{d}_x} \quad \text{m/pixel}
\end{equation}
\pagebreak
\section{Local Robot Frames}

\subsection{From Label Markers to Label Frame}

\begin{figure}[H]
\centering
\includesvg[width=0.5\textwidth]{labelworld}
\caption{Local vehicle frame definitions
\label{fig:labelworld}}
\end{figure}


First, transform pixel locations to world coordinates:
%
\begin{equation}
\br\sub{center}^w = H^{\inert}_p \btr\sub{center}^p, \quad \br\sub{top}^w = H^{\inert}_p \btr\sub{top}^p
\end{equation}
%
Obtain the label x and y axes in world coordinates:
%
\begin{align}
\xh_\ell^{\inert}= \dfrac{r\sub{top}^w-r\sub{center}^w}{\twonorm{r\sub{top}^w-r\sub{center}^w}} \qcom \yh_\ell^{\inert} = \begin{bmatrix}
0 & -1\\
1 & 0
\end{bmatrix}\xh_\ell
\end{align}
%
The transformation matrix becomes:
%
\begin{equation}
\br^{\inert} =H^{\inert}_\ell 
\br^\ell\qcom H^{\inert}_\ell = \begin{bmatrix}
\xh_\ell^{\inert} & \yh_\ell^{\inert} & r^{\inert}\sub{center}\\
0 & 0 & 1
\end{bmatrix}
\end{equation}


\todos{Agree on a better name than center. This is confusing}

\subsection{From Label Frame to Robot Frame}


\begin{equation}
\br^b = \begin{bmatrix}
I_2 & r^b\sub{center}\\
0& 1
\end{bmatrix}\br^\ell
\end{equation}

\begin{figure}[H]
\centering
\includesvg[width=0.7\textwidth]{robotframe}
\caption{Local vehicle frame definitions
\label{fig:robotframe}}
\end{figure}

\section{Relative Agent Positions and Orientations}




\end{document}